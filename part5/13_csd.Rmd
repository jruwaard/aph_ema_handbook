# (PART) EMA Case Studies {-}

# Early Warning Signs of Depression {#csd}

One of the promises of EMA is that it might detect signs of mental health
detoriation in an early stage. Subtle changes in time series of mood variables,
for example, might signal a depression relapse. If we can detect these
changes, preventive interventions can be triggered to avoid the relapse.

But what changes, exactly, should we look for? What are these early warning
signs?


## Critical Slowing Down

Critical Slowing Down (CSD) is a concept from dynamic systems theory. In
dynamic systems, state transitions are preceded by a change in which the system
reacts to disturbances. In a stable state, the system quickly recovers from
disturbances. Prior to a transition to a new state, however, the system takes
more and more time to recover back to its current state: the variance and auto-correlation of the system increases [@Scheffer2009; @Dakos2010]. 

In this chapter, we re-analyze data from a study that aimed to demonstrate CSD
in EMA-data of a single patient with a history of major depression [@Groot2010,
@Kossakowski2017; @Wichers2016]. The patient, a 57-year old male, used EMA to monitor himself during a 239-day single-case double-blind medication reduction trial. He experienced a relapse, and Wichers and colleagues showed how variance and auto-correlation in the EMA data increased, several weeks prior to the relapse. The transition appeared to be preceded by CSD.

We will try to reconstruct the finding, using an alternative analysis strategy. One of the limitations of the Wicherts et al analysis is that autocorrelation was analysed at lag 1 only (i.e., only the correlation between t and t-1 was considered). With another analysis technique, called 'Detrended Fluctuation Analysis', all lags can be considered. 

To conduct the analysis, we need three R packages: 

- Raw EMA data of this study were published in the public domain
[@Kossakowski2017]. We included the data in the emaph package.

- To manipulate the raw data and reconstruct the plots of the article, we are
going to use several functions from the tidyverse.

- DFA is implemented in package 'nonlinearTseries', so we will need that as well.

```{r cs13a}
# Code snippet 13.1: required libraries for the CSD-study re-analysis.
library(emaph)
library(tidyverse)
library(nonlinearTseries)
```


## Plotting the course of depression 

Let's take a look at the development of the depressive symptoms of the patient first. These were tapped with weekly assessments of the depression scale of the 'Symptom Checklist-90-Revised' [SCL-90-R; @Derogatis1994], a well-established self-report questionnaire.

The code below reconstructs Figure 1 of the Wichers et al article. It plots the SCL90-R depression scale score over the time. Around day 120, the depression score increased considerable: the patient experienced a relapse.

```{r cs13b, fig.cap = "SCL-90 depression score, over the study period", fig.asp = .3}
# Code snippet 13.2: Plot depression score
dep <- csd %>% select(dayno, scl90r_dep) %>%
  filter(!is.na(scl90r_dep)) %>% unique

# plot dep + change point (day 120 in our data)
ggplot(dep, aes(x = dayno, y = scl90r_dep, group = 1)) +
  geom_step() + scale_colour_manual(values = c("black", "red")) +
  guides(colour = FALSE)
```


## Mental state EMA items

Wichers and colleagues selected 13 items from the full EMA dataset, which they grouped in 5 factors: positive affect (pa; 4 items), negative affect (na; 4
items), mental unrest (mu; 3 items), suspiciousness (su; 1 item), and worrying
(wo; 1 item). From these factors, an overall mental state sum score can be calculated.

```{r cs13c}
# Code snippet 13.3: mood states calculation

# positive affect
pa_items <- c("mood_enthus", "mood_cheerf",
              "mood_strong", "mood_satisfi")

csd$pa <- csd %>%
  select(pa_items) %>%
  rowMeans(., na.rm = TRUE)
csd$pa <- -csd$pa

# negative affect
na_items <- c("mood_lonely", "mood_anxious",
              "mood_guilty", "mood_doubt")

csd$na <- csd %>%
  select(na_items) %>%
  rowMeans(., na.rm = TRUE)

# mental unrest
mu_items <- c("mood_irritat", "pat_restl",
              "pat_agitate")
csd$mu <- csd %>%
  select(mu_items) %>%
  rowMeans(., na.rm = TRUE)

# 'single-item' states
csd$su <- csd$mood_suspic
csd$wo <- csd$pat_worry

# global mental state score
csd$ms <- rowSums(csd[c("pa", "na", "mu", "su", "wo")])
```

Rows, in which one or more of the factors have missing values, are removed from the analysis. In a full analysis, options to impute the missing values could and should be considered. However, since only 3 of the 1476 rows have missing item scores, not much is probably lost by running a simple complete-case analysis.

```{r cs13d}
# Code snippet 13.3: missing value removal

# count number of items with missing items, per row
csd$nna <- csd %>%
  select(matches("mood_")) %>%
  is.na(.) %>% rowSums

# drop rows with missing values
csd <- csd %>% filter(nna == 0)
```


## Running the DFA

```{r}
d <- NULL
d <- csd %>% 
  group_by(dayno) %>%
  summarise(ms = mean(ms))

e <- d %>% right_join(data.frame(dayno = 1:max(csd$dayno)))

d$ms_dfa = NA; d$ms_m = NA

window <- 32
for(i in seq(window, max(csd$dayno), 5)) {

  # get the sliding window data
  w <- subset(csd, dayno > (i - window) & dayno <= i)

  # dfa: ms
  dfa.analysis = dfa(time.series = w$ms,
                     npoints = 30,
                     window.size.range = c(10, nrow(w)),
                     do.plot = FALSE)

  fgn.estimation = estimate(dfa.analysis,
                            do.plot = FALSE,
                            fit.col="blue", fit.lwd = 2, fit.lty = 2,
                            main="Fitting DFA to fGn")
  d$ms_dfa[d$dayno == i] <- fgn.estimation
  d$ms_m[d$dayno == i] = mean(w$ms)
}
```



## Results

We can now plot the DFA indicator over time, to see whether it peaks prior to the onset of the relapse. As can be seen, the DFA-indicator clearly pleaks prior to the onset of the relapse, around day 110. Interestingly, a second peak is reached at the end of the experiment, around day 239, possibly to indicate a recovery from the relapse. 


```{r cs13h, eval = TRUE, fig.asp = .4, fig.cap="Results of the DFA analysis.", warning = FALSE}
# Code snippet 13.8: Plot DFA results

# dfa
e <- subset(d, !is.na(ms_dfa))
g = ggplot(e,
           aes(x = dayno, y = ms_dfa, 
               colour = factor(dayno < 120), 
               group = 1)) +
  # geom_step() +
  geom_line() + 
  ylab("dfa (60-day window)") + 
  xlim(c(0, 250)) + 
  guides(color = FALSE)
g
```


## Discussion

Vestibulum hendrerit tempus condimentum. Donec a mollis sem. Aenean lectus nunc,
bibendum ut orci vel, tristique pellentesque arcu. Vestibulum id laoreet neque.
Phasellus at ex velit. Vestibulum scelerisque nulla ut massa tempor, ac dapibus
dui viverra.

Vestibulum hendrerit tempus condimentum. Donec a mollis sem. Aenean lectus nunc,
bibendum ut orci vel, tristique pellentesque arcu. Vestibulum id laoreet neque.
Phasellus at ex velit. Vestibulum scelerisque nulla ut massa tempor, ac dapibus
dui viverra.

Vestibulum hendrerit tempus condimentum. Donec a mollis sem. Aenean lectus nunc,
bibendum ut orci vel, tristique pellentesque arcu. Vestibulum id laoreet neque.
Phasellus at ex velit. Vestibulum scelerisque nulla ut massa tempor, ac dapibus
dui viverra.

Vestibulum hendrerit tempus condimentum. Donec a mollis sem. Aenean lectus nunc,
bibendum ut orci vel, tristique pellentesque arcu. Vestibulum id laoreet neque.
Phasellus at ex velit. Vestibulum scelerisque nulla ut massa tempor, ac dapibus
dui viverra.
