# (PART) EMA Case Studies {-}


# Early Warning Signals of Depression: The Critical Slowing Down Study {#csd}

One of the unique selling points of EMA is that it might help to identify early
warning signs of serious mental health detoriation. Subtle changes in time
series of mood variables, for example, might signal a depression relapse. If we
can reliably identify detect these changes, it might be possible to intervene
early, to prevent the relapse from occuring.

But what changes, exactly, should we look for? What are these early warning
signs?


## Critical Slowing Down

Critical Slowing Down (CSD) is a concept from dynamic systems theory. In
a dynamic system, the theory posits, qualitative state changes
are preceded by a change in which the system recovers from disturbances
(perturbations). In the stable situation, the systems quickly recovers back to
the equilibrium state. Prior to a transition to a new equilibrium, however, this
recovery-time increases. 

There are three statistical indicators of CSD [Scheffer2009; Dakos2010]:

- Increased variance

- Increased auto-correlation

- Increased spatial correlation (i.e., iter-item correlations)


## The CSD N = 1 Study

In an explorative study, data suggested that CSD was associated with depression severity [VandeLeemput2014]. This was a between-subject finding, however. CSD remained to be demonstrated in within-subject data.

In this chapter, we re-construct a study that aimed to demonstrate CSD in
EMA-data of a single patient with a history of major depression [@Groot2010,
@Kossakowski2017; @Wichers2016]. The patient, a 57-year old male, monitored
himself extensively for 239 days, during a single case double-blind medication
reduction trial. While doing so, he experienced a relapse. Was this transition
preceded by a CSD of his mood state?


## Preliminaries

For this reconstruction, we need two R packages: 

- Raw EMA data of this study were published in the public domain
[@Kossakowski2017]. We included the data in the emaph package.

- To manipulate the raw data and reconstruct the plots of the article, we are
going to use several functions from the tidyverse.

```{r cs131, eval = FALSE}
# Code snippet 13.1: required libraries for the csd reconstruction
library(emaph)
library(tidyverse)
```


## Plotting the course of depression 

Let's take a look at the development of depressive symptoms first. These were
tapped with weekly assessments. The patient answered all thirtheen items of
the depression scale of the 'Symptom Checklist-90-Revised' (SCL-90-R), a well-established self-report measure [@Derogatis1994].

The code below reconstructs Figure 1 in the Wichers et al study. It plots `csd$scl90r_dep`, the SCL90-R depression scale score (the mean of the SCL-90 item-scores), by `csd$dayno`(the time variable). Different phases of the experiment (`csd$phase`) are marked by different colors. 

```{r cs132, fig.asp = .5}
# Code snippet 13.2: Plot depression score

# get scl-90 data and day / phase
d <- csd %>% 
  filter(!is.na(scl90r_dep)) %>% 
  select(dayno, phase, scl90r_dep)

# retain only one scl-90-r assessment per day
d <- unique(d) 

# reconstruct Figure 1 in Wicherts et al 2016.
ggplot(data = d, 
       aes(x = dayno, 
           y = scl90r_dep, 
           group = 1)) +
  geom_point(aes(color = phase)) + 
  geom_step(aes(color = phase)) + 
  scale_x_continuous(breaks = seq(from = 1, 
                     to = 239, 
                     by = 9)) +
  theme(axis.text.x = element_text(angle = 90, 
                                   hjust = 1),
        legend.position="top")
```

The plot shows how the depression relapse develops over time. After day
127, several weeks after the full reduction of the medication, the depression
score increased considerably. This is confirmed by a change score analysis:

```{r cs132b}
# Code snippet 13.3: Change score analysis of depression scores
fm <- lm(scl90r_dep ~ I(dayno > 127), data = d)
summary(fm)
```

```{r eval = FALSE}
library(ecp)
e1 = e.divisive(matrix(d$scl90r_dep), sig = .01, min.size = 5)
d$cluster <- e1$cluster
```

### Defining the mental states

The researchers selected 13 items from the full EMA dataset. They grouped
these items in 5 factors: positive affect (pa; 4 items), negative affect (na; 4
items), mental unrest (mu; 3 items), suspiciousness (su; 1 item), and worrying
(wo; 1 item). 

```{r cs133}
# Code snippet 13.3: mood state calculation

# positive affect
pa_items <- c("mood_enthus", "mood_cheerf", 
              "mood_strong", "mood_satisfi")

# negative affect  
na_items <- c("mood_lonely", "mood_anxious", 
              "mood_guilty", "mood_doubt")

# mental unrest
mu_items <- c("mood_irritat", "pat_restl", 
              "pat_agitate")

# calculate factor scores

csd$pa <- csd %>%
  select(pa_items) %>%
  rowMeans(., na.rm = TRUE)
csd$pa <- -csd$pa

csd$na <- csd %>%
  select(na_items) %>%
  rowMeans(., na.rm = TRUE)

csd$mu <- csd %>%
  select(mu_items) %>%
  rowMeans(., na.rm = TRUE)

csd$su <- csd$mood_suspic
csd$wo <- csd$pat_worry
```


### Remove rows with many missing values.

In this reconstruction, we calculate the overall mental state score as the sum
of the detrended scores of the five factors.

For the overall mood state variable to be valid, its factors should be
adequately measured. Rows, in which one or more of the factors had missing
values, are therefore removed from the analysis.

```{r cs134}
# Code snippet 13.4: missing value removal
csd$nna <- csd %>%
  select(matches("mood_")) %>%
  is.na(.) %>% rowSums
csd <- csd %>% filter(nna == 0)
```


## De-trending the mood states

Since trends in time-series can distort the variance and autocorrelation, we
mood state variables were detrended.

To de-trend, we fit a generalized additive model with a spline-based smoother.
This models the trend. By using the residuals of his model (i.e., by subtracting
the predicted score from the observed score), the trends are removed.

```{r}
library(KernSmooth)

detrend <- function(y) {
  x <- as.numeric(as.POSIXct(paste(csd$date, csd$resptime_s)))
  est <- locpoly(x, 
                 y, 
                 degree = 3, bandwidth =  604800, gridsize = length(y))
  #plot(est, type = "l")
  
  #fm <- mgcv::gam(formula = y ~ s(dayno, bs = "cs"), data = csd)
  #residuals(fm)
  y - est$y
}

csd$pa_dt <- detrend(csd$pa) 
csd$na_dt <- detrend(csd$na) 
csd$mu_dt <- detrend(csd$mu) 
csd$su_dt <- detrend(csd$su) 
csd$wo_dt <- detrend(csd$wo) 
```

Let's take a look at the effec of detreding. If we plot positve affect over
time, we see a gradually increase, and two embedded subtrends. The detrended
variable does not display these trends anymore.

```{r cs135, fig.asp = .8}
# Code snippet 13.5: demonstrate detrending

# store pa and pa_dt in a long format dt, to facet on them in the plot
d <- csd %>% 
  select(pa, pa_dt, dayno) %>% 
  gather(pa, pa_dt, -dayno, 
         key = "v", value = "score")

# compare raw and detrended pa
g <- ggplot(data = d, 
            aes(x = dayno, 
                y = score)) +
  geom_smooth() + 
  geom_line(alpha = .5, size = .5) + 
  scale_x_continuous(
    breaks = seq(from = 1, 
                 to = 239, 
                 by = 9)) +
  facet_grid(v~., scales = "free") + 
  theme(
    axis.text.x = element_text(angle = 90, 
                               hjust = 1))

g
```


## Calculating the moving average of mood state variance & autocorrelation

The variance and autocorrelation are calculated from the summed, standardized
mood states.

```{r cs138b}
csd$ms <- csd %>% select(pa_dt, na_dt, mu_dt, wo_dt, su_dt) %>% 
  rowSums
```

Both the variance and the lag-1 autocorrelation are calculated using a 30-day sliding window. 

```{r cs138}
# Code snippet 13.8: calculating variance and auto-correlation in 30-day windows
d <- data.frame(dayno = 1:max(csd$dayno))
d <- left_join(d, unique(csd[c("dayno", "phase")]))
d$phase[d$dayno == 125] = "exp: zero" # no data at day 125

d$ms_rv = NA
d$ms_rac = NA
for(i in 30:max(csd$dayno)){

  # get the 30-day data window
  w <- subset(csd, 
              dayno > (i - 30) & 
              dayno <= i)
  
  # get variance
  d$ms_rv[i] <- var(w$ms, na.rm = TRUE)
  
  # get the autocorrelation
  d$ms_rac[i] <- cor(w$ms, lag(w$ms), use = "complete.obs")
}
```


## Mood state variance

We can now plot the mood state variance. Did it, as predicted, increase
considerably prior to the relapse around day 120?

```{r cs1310, fig.asp = .5}
# Code snippet 13.10: Plot variance
ggplot(data = d, 
       mapping = aes(x = dayno, 
                     y = sqrt(ms_rv))) +
  geom_line(mapping = aes(color = phase,
                          group = 1)) +
  scale_x_continuous(breaks = seq(from = 1, 
                                  to = 239, 
                                  by = 9)) +
  scale_y_continuous(limits = c(1, 3.5),
                     breaks = seq(from = 1,
                                  to = 3.5,
                                  by = 0.5)) + 
  theme(axis.text.x = element_text(angle = 90, 
                                   hjust = 1),
        legend.position="top", 
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank())
```


## MoodState Autocorrelation

Did the lag-1 autocorrelation also increase prior to day 120?

```{r cs1311, fig.asp = .5}
# Code snippet 13.11: Plot autocorrelation
ggplot(data = d, 
       aes(x = dayno, 
           y = ms_rac)) +
  geom_line(aes(color = phase, 
                group = 1)) +
  scale_x_continuous(
    breaks = seq(from = 1, 
                 to = 239, 
                 by = 9)) +
  theme(axis.text.x = element_text(angle = 90, 
                                   hjust = 1),
        legend.position="top",
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank())
```

## Network analysis



## Discussion

Vestibulum hendrerit tempus condimentum. Donec a mollis sem. Aenean lectus nunc,
bibendum ut orci vel, tristique pellentesque arcu. Vestibulum id laoreet neque.
Phasellus at ex velit. Vestibulum scelerisque nulla ut massa tempor, ac dapibus
dui viverra.

Vestibulum hendrerit tempus condimentum. Donec a mollis sem. Aenean lectus nunc,
bibendum ut orci vel, tristique pellentesque arcu. Vestibulum id laoreet neque.
Phasellus at ex velit. Vestibulum scelerisque nulla ut massa tempor, ac dapibus
dui viverra.

Vestibulum hendrerit tempus condimentum. Donec a mollis sem. Aenean lectus nunc,
bibendum ut orci vel, tristique pellentesque arcu. Vestibulum id laoreet neque.
Phasellus at ex velit. Vestibulum scelerisque nulla ut massa tempor, ac dapibus
dui viverra.

Vestibulum hendrerit tempus condimentum. Donec a mollis sem. Aenean lectus nunc,
bibendum ut orci vel, tristique pellentesque arcu. Vestibulum id laoreet neque.
Phasellus at ex velit. Vestibulum scelerisque nulla ut massa tempor, ac dapibus
dui viverra.


