
# R packages for EMA research {#rcat}

Many R packages exist to ease up the management and analysis of EMA data. In this chapter, some of these packages are discussed. For each, we provide a summary description, and example  code snippets. 

Table: (\#tab:rcat) Alphabetic list of R packages that are useful in EMA research.

+----------------+-------------------+-----------------------------------------+
| Name           | Category          | Description                             |
+:===============+:==================+:========================================+
| adehabitatHR   | Passive EMA data  | Developed for home range estimation of  |
|                | analysis          | wild animals from GPS data. Useful for  |
|                |                   | human data as well (see Chapter         |
|                |                   | \@ref(homerange)).                      | 
+----------------+-------------------+-----------------------------------------+
| autovar        | Symptom Networks  | Automate the construction of vector     |          
|                |                   | autoregressive models.                  |
+----------------+-------------------+-----------------------------------------+
| bootnet        | Symptom Networks  | Determine the stability of symptom      |
|                | analysis          | networks.                               |
+----------------+-------------------+-----------------------------------------+ 
| GGIR           | Accelerometer     | Simplifies management and analysis of   |
|                | Data              | raw accelerometer data.                 |          
+----------------+-------------------+-----------------------------------------+
| lme4           | Mixed Modeling    | Fit linear and nonlinear mixed effects  |
|                |                   | models. More efficient reimplementation |
|                |                   | of package 'nlme', that also provides   |
|                |                   | options for generalised modeling.       |
+----------------+-------------------+-----------------------------------------+
| lomb           | GPS data          | Calculate the Lomb-Scargle Periodogram  |
|                |                   | for unevenly sampled time series.       |
+----------------+-------------------+-----------------------------------------+ 
| nlme           | Mixed Modeling    | Fit linear and nonlinear mixed effects  |
|                |                   | models. Pre-dates package lme4, but is  |
|                |                   | still used because it a provides more   |
|                |                   | advanced options to model correlational |
|                |                   | structures in the data.                 |
+----------------+-------------------+-----------------------------------------+
| powerlmm       | Power analysis    | power calculation for two- and three-   |
|                |                   | level multilevel models with missing    |
|                |                   | data.                                   | 
+----------------+-------------------+-----------------------------------------+
| simr           | Power analysis    | Simulation-based power calculations for |
|                |                   | mixed models                            |
+----------------+-------------------+-----------------------------------------+
| simstudy       | Data simulation   | Simulating study data.                  | 
+----------------+-------------------+-----------------------------------------+
| tidyverse      | Data Management & | Well-designed set of packages           |
|                | Visual Exploration| for data management and data            |
|                |                   | visualisation.                          |
+----------------+-------------------+-----------------------------------------+
| qgraph         | Symptom Networks  | Estimate and plot symptom networks.     |
|                | analysis          |                                         |
+----------------+-------------------+-----------------------------------------+


## Data management & Visual Exploration

### Package `tidyverse`
\index{tidyverse}

This package is actually a collection of well-designed packages, that together provide a highly useful and consistent modern extention of the base R language. The tidyverse includes popular packages such as "ggplot2" (for plotting), "haven" (to read SPSS files), "dplyr" (for data manipulation), and many more (see: http://tidyverse.org for a full list).

```{r cs18a}
# code snippet 18.1: loading the tidyverse package
library(tidyverse)
```

#### Package `ggplot2`
\index{ggplot2}

This package is used throughout the book to produce all graphs. It provides a collection of high-level plotting commands with which graphs can be build up as a series of layers. It is based on 'The Grammar of Graphics' [@wilkinson2006], an influential analysis of the general structure of scientific graphs.

The package is very popular. Many tutorials on how to use the package to produce graphs can be found on the web. Systematic introductions are available on the [the tidyverse website](http://ggplot2.tidyverse.org/), and in a book written by lead author Hadley Wickham [@wickham2016ggplot2].

```{r cs18b, fig.cap = "Plotting layers with ggplot2", out.width = '45%', fig.show = "hold"}
# code snippet 18.2: simple ggplot example
d = data.frame(
  ID    = rep(1:4, each = 25),
  time  = rep(1:25, 4), 
  score = rnorm(100, 0, 2))

# initialise the plot area and the data mapping
g <- ggplot(d, aes(x = time, y = score))
g

# add scatterplot
g <- g + geom_point()
g

# fit a smoothed line
g <- g + geom_smooth()
g

# split plot by ID
g + facet_wrap(~ ID)
```

#### Package `dplyr`
\index{dplyr}

Package 'dplyr' is an attempt to provide a grammar of data manipulations. With 'dplyr', elementary data manipulations can be chained using the piping operator '%>%' to implement highly complex data transformations. A good introduction can be found in 'R for data science', which can be freely accessed online (http://r4ds.had.co.nz/) 

```{r cs18c, dplyr_example}
# code snippet 18.3: aggregate data by ID, through a 'pipe'
d %>% 
  group_by(ID) %>%
  summarise(mean_score = mean(score)) %>%
  round(., 2)
```

## Linear mixed modeling

Several R-packages for mixed modelling exist. The most popular are package **nlme** [@R-nlme] and package ***lme4** [@Bates2015]. Both packages are actively used, as both provide unique functionalities. 

### nlme
\index{nlme}

Package **nlme** is introduced in chapter \@ref(lmm). It is an older package (in comparison to package lme4), that is still used a lot because it provides options to model correlational structures that are not implemented (yet) in lme4.

```{r cs18d, nlme_example}
# code snippet 18.4: fit a linear mixed model, with lme
library(nlme)
fm <- lme(distance ~ age + Sex, data = Orthodont, random = ~ 1)
summary(fm)
```

### lme4
\index{lme4}

Package **lme4** [@Bates2015] is a faster R-reimplementation of the mixed effects model. With large data sets and complex hierarchical models, this package should probably be preferred.

```{r cs18e, lme4_example, eval=FALSE}
# code snippet 18.4: fit a linear mixed model, with lme
library(lme4)
fm <- lmer(distance ~ age + Sex + (1 | Subject), data = Orthodont)
summary(fm)
```

## Power analysis

### Powerlmm

```{r cs3b}
# code snippet 3.2: Power analysis of a two-group repeated measures design
# (analytical approach)
library(powerlmm)
p <- study_parameters(n1 = 24,  
                      n2 = 40,
                      effect_size = cohend(0.5, 
                                           standardizer = "pretest_SD"),
                      icc_pre_subject = 0.5,
                      var_ratio = 0.01)

get_power(p)
```

Note the two additional variables in the 'study_parameters' call: 'icc_pre_subject', and 'var_ratio'. According to the package documentation (?study_parameters), 'icc_pre_subject' refers to the 'amount of baseline variance at the subject level', and 'var_ratio' refers to the 'ratio of the random slope variance to the within-subject variance'.

### Package 'simr'

With package 'simr' [@Green2016], power of mixed models can be determined via simulation:

```{r cs3c}
# code snippet 3.3: Power analysis of a two-group repeated measures design
# (simulation approach)
library(simr)

# construct design matrix
t <- 1:24
s <- 1:40 
X   <- expand.grid(t = t, s = s)
X$g <- c(rep(0, 24), rep(1, 24))

# fixed intercept and slope
b <- c(2, -0.1, -0.5)

# random intercept variance
V1 <- 0.5                     

# random intercept and slope variance-covariance matrix
V2 <- matrix(c(0.5, 0.05, 0.05, 0.1), 2) 

# residual standard deviation
s <- 1 

model1 <- makeLmer(y ~ t + g + (1 | s), 
                   fixef = b, 
                   VarCorr = V1, 
                   sigma = s, 
                   data = X)

powerSim(model1, 
         fixed("g", "lr"), 
         nsim = 10,
         progress = FALSE)
```


## Analysis of passive EMA data

### Accelerometer data: Package 'GGIR'
\index{GGIR}

Lorem ipsum dolor sit amet, consectetur adipiscing elit. Aliquam vehicula augue metus, in tincidunt urna luctus sit amet. Sed ultrices, erat at laoreet semper, sem tellus hendrerit mi, eget pulvinar massa nisl ac dolor. Nunc ac tellus nec tortor interdum porta. Vestibulum hendrerit tempus condimentum. Donec a mollis sem. Aenean lectus nunc, bibendum ut orci vel, tristique pellentesque arcu. Vestibulum id laoreet neque. Phasellus at ex velit. Vestibulum scelerisque nulla ut massa tempor, ac dapibus dui viverra.  

Donec sed lectus at sem ultrices commodo. Proin a viverra metus, nec scelerisque odio. Morbi viverra tristique libero vel fringilla. Sed at varius erat, id consequat nibh. Ut eget leo blandit orci posuere tincidunt ac sed erat. Aenean metus metus, eleifend ut facilisis a, fringilla ut neque. Nunc hendrerit cursus eleifend. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. Vivamus enim turpis, pulvinar volutpat
purus nec, lobortis imperdiet diam.   


### GPS data: Package 'lomb'
\index{Lomb-Scargle periodogram}
\index{lomb}

Package **lomb** simplifies the computation of Lomb-Scargle periodograms. Proin a viverra metus, nec scelerisque odio [@ruf1999]. Morbi viverra tristique libero vel fringilla. Sed at varius erat, id consequat nibh [@Saeb2015]. Ut eget leo blandit orci posuere tincidunt ac sed erat. Aenean metus metus, eleifend ut facilisis a, fringilla ut neque. Nunc hendrerit cursus eleifend. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. Vivamus enim turpis, pulvinar volutpat purus nec, lobortis imperdiet diam.

```{r cs18f, out.width='98%'}
# code snippet 18.5: calculating a Lomb-Scargle periodogram
data(ibex, package = "lomb") 
lomb::lsp(ibex[2:3]) 
```


### GPS data: Package `adehabitatHR`
\index{Homerange estimation}

Package **adehabitatHR** at sem ultrices commodo. Proin a viverra metus, nec scelerisque odio. Morbi viverra tristique libero vel fringilla [@Calenge2006]. Sed at varius erat, id consequat nibh. Ut eget leo blandit orci posuere tincidunt ac sed erat. Aenean metus metus, eleifend ut facilisis a, fringilla ut neque. Nunc hendrerit cursus eleifend. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. Vivamus enim turpis, pulvinar volutpat purus nec, lobortis imperdiet diam.

```{r cs18g, eval = FALSE}
library(adehabitatHR)
```


## Symptom Network Analysis
\index{symptom networks}

Lorem ipsum dolor sit amet, consectetur adipiscing elit. Aliquam vehicula augue metus, in tincidunt urna luctus sit amet. Sed ultrices, erat at laoreet semper, sem tellus hendrerit mi, eget pulvinar massa nisl ac dolor (see Chapter \@ref(networks)).

### Package 'qgraph`
\index{qgraph}

Lorem ipsum dolor sit amet, consectetur adipiscing elit. Aliquam vehicula augue metus, in tincidunt urna luctus sit amet [@Epskamp2012]. Sed ultrices, erat at laoreet semper, sem tellus hendrerit mi, eget pulvinar massa nisl ac dolor. Nunc ac tellus nec tortor interdum porta. Vestibulum hendrerit tempus condimentum. Donec a mollis sem. Aenean lectus nunc, bibendum ut orci vel, tristique pellentesque arcu. Vestibulum id laoreet neque. Phasellus at ex velit. Vestibulum scelerisque nulla ut massa tempor, ac dapibus dui viverra.  

Donec sed lectus at sem ultrices commodo. Proin a viverra metus, nec scelerisque odio. Morbi viverra tristique libero vel fringilla. Sed at varius erat, id consequat nibh. Ut eget leo blandit orci posuere tincidunt ac sed erat. Aenean metus metus, eleifend ut facilisis a, fringilla ut neque. Nunc hendrerit cursus eleifend. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. Vivamus enim turpis, pulvinar volutpat purus nec, lobortis imperdiet diam.


### Package 'bootnet`
\index{bootnet}

Donec sed lectus at sem ultrices commodo. Proin a viverra metus, nec scelerisque odio. Morbi viverra tristique libero vel fringilla [@Epskamp2018a]. Sed at varius erat, id consequat nibh. Ut eget leo blandit orci posuere tincidunt ac sed erat. Aenean metus metus, eleifend ut facilisis a, fringilla ut neque. Nunc hendrerit cursus eleifend. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. Vivamus enim turpis, pulvinar volutpat
purus nec, lobortis imperdiet diam.  


### Package 'autovar`
\index{autovar}
\index{vector autoregressive models}

Donec sed lectus at sem ultrices commodo. Proin a viverra metus, nec scelerisqueodio. Morbi viverra tristique libero vel fringilla [@VanderKrieke2015]. Sed at varius erat, id consequat nibh. Ut eget leo blandit orci posuere tincidunt ac sed erat. Aenean metus metus, eleifend ut facilisis a, fringilla ut neque. Nunc hendrerit cursus eleifend. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. Vivamus enim turpis, pulvinar volutpat purus nec, lobortis imperdiet diam. 

Vivamus enim turpis, pulvinar volutpat purus nec, lobortis [http://autovar.nl](https://autovar.nl/)

